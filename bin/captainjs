#!/usr/bin/env node
var fs = require('fs'),
    os = require('os'),
    crypto = require('crypto'),
    path = require('path');

var program = require('commander'),
    async = require('async'),
    uuid = require('node-uuid');

var pkg = require('../package.json'),
    db = require('./../lib/db'),
    util = require('../lib/util');

program
  .version(pkg.version)
  .option('createuser', 'Creates a user account')
  .option('syncdb', 'Synchronise all definitions')
  .option('loaddata [filename]', 'Loads data')
  .option('init [projectname]', 'Creates a new project')
  .option('-f, --force', 'Force operation')
  .parse(process.argv);


/**
 * echo str > path.
 *
 * @param {String} path
 * @param {String} str
 */

function write(path, str) {
  fs.writeFileSync(path, str);
  console.log(util.cyan('   create : ') + path);
}

/**
 * Mkdir.
 *
 * @param {String} path
 */

function mkdir(path) {
  if(!fs.existsSync(path)) {
    fs.mkdirSync(path, 0755);
    console.log(util.cyan('   create : ') + path);
  } else {
    console.log(util.yellow('   dir exists : ') + path);
  }
}

/**
 *
 * Creates on dir at `base`, and x `subs` under it.
 *
 * @param {String} base
 * @param {Array} subs
 */

function dirs(base, subs) {
  mkdir(base);
  subs.forEach(function(sub) {
    mkdir(path.join(base, sub));
  });
}


/**
 * Test if `path` is empty.
 *
 * @param {String} path
 */

function isEmptyDirectory(path) {
  var files;
  try {
    files = fs.readdirSync(path);
    if(files.length > 0) {
      return false;
    }
  } catch(err) {
    if(err.code) {
      util.abort('Error: ', err);
    } else {
      throw e;
    }
  }
  return true;
}

/**
 * Synchronize database.
 *
 * @param {Boolean} forceDrop
 */

function syncDB(forceDrop) {
  db.syncDB({
    oncomplete: function(err) {
      if(err) {
        util.abort('Failed syncing', err);
      } else {
        util.exit('\nAll done\n\n');
      }
    },

    onprogress: function(script) {
      console.log('Running: \n========\n%s\n', script);
    },

    forceDrop: forceDrop
  });
}

// Templates

function files(name) {
  var index = [
      'var express = require(\'express\');'
    , 'var app = express();'
    , ''
    , 'var core = require(\'captainjs-core\');'
    , 'var admin = require(\'captainjs-admin\');'
    , 'var settings = core.modules.settings;'
    , ''
    , 'app.use(\'/admin\', admin);'
    , 'app.use(core);'
    , 'app.listen(settings.get(\'PORT\'), settings.get(\'HOST\'));'
    , ''
    , 'console.log(\'Running at http://%s:%d\', settings.get(\'HOST\'), settings.get(\'PORT\'));'
  ].join(os.EOL);


  var pkg = [
      '{'
    , '  "name": "' + name + '",'
    , '  "description": "",'
    , '  "version": "0.0.1",'
    , '  "private": true,'
    , '  "dependencies": {'
    , '    "express": "*",'
    , '    "captainjs-admin": "*",'
    , '    "captainjs-core": "*"'
    , '  },'
    , '  "scripts": {'
    , '    "start": "node index.js"'
    , '   }'
    , '}'
  ].join(os.EOL);

  return {
    'index.js': index,
    'package.json': pkg,
    'README.md': '## ' + name
  };
}

// Handlers

if(program.createuser) {
  program.prompt('username: ', function(username) {
    program.password('password: ', '*', function(password) {
      program.password('confirm password: ', '*', function(password2) {
        if(password != password2) {
          return util.abort('Password do not match, bailing out.');
        }
        program.prompt('email: ', function(email) {
          var body = {username: username, password: password, isStaff: true, email: email};

          db.users.create(body, function(err) {
            if(err) {
              util.abort('Failed to created user', err);
            } else {
              util.exit('\nUser created!\n\n');
            }
          });
        });
      });
    });
  });
}

else if(program.syncdb) {
  if(program.force) {
    syncDB(true);
  } else {
    program.prompt('Force drop? (y/n): ', function(answer) {
      var forceDrop = !!answer.match(/y|yes|arrr/);
      syncDB(forceDrop);
    });
  }
}

else if(program.loaddata) {
  (function() {
    var files = [];
    var filename = program.loaddata;
    var stats = fs.statSync(filename);

    if(stats.isDirectory()) {
      fs.readdirSync(filename).forEach(function(file) {
        files.push(path.join(filename, file));
      });
    } else {
      files.push(filename);
    }

    files = files.map(function(file) {
      return db.load(file);
    });

    async.series(files, function(err){
      if(err) {
        util.abort('Failed loading data', err);
      } else {
        util.exit('\nAll done.\n\n');
      }
    });
  }());
}

else if(program.init) {
  var target = program.init;

  function initProject(name) {
    console.log(util.cyan('Creating project: ') + name);
    console.log();

    // Creating dirs
    dirs(name, ['media', 'cache', 'logs']);

    // Creating files
    var templates = files(name);
    Object.keys(templates).forEach(function(key) {
      var p = path.join(name, key);
      write(p, templates[key]);
    });

    // Instructions
    console.log();
    console.log(util.cyan('Now run: '));
    console.log('    cd ' + target);
    console.log('    npm install');
    console.log('    npm start');
  }

  if(fs.existsSync(target) && !isEmptyDirectory(target) && !program.force) {
    program.prompt('Directory not empty, force create? (y/n): ', function(answer) {
      var forceCreate = !!answer.match(/y|yes|arrr/);

      if(forceCreate) {
        initProject(target);
      } else {
        util.abort('Cowardly refusing to init project in a non-empty directory');
      }
    });
  } else {
    initProject(target);
  }
}

else {
  program.help();
}